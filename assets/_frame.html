<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Apptron</title>
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
  </style>
  <script type="module">
    // copied from apptron.js to avoid import
    function isLocalhost() {
        const hostname = window.location.hostname;
        return hostname === "localhost" || hostname === "127.0.0.1" || hostname === "::1";
    }
    function appHost() {
      const hostname = window.location.origin.replace("https://", "").replace("http://", "");
      if (isLocalhost()) {
        return hostname;
      }
      const parts = hostname.split(".");
      if (parts.length >= 2) {
        return parts.slice(-2).join(".");
      }
      return hostname;
    }

    // accept messages to redirect at the top level
    // this handles redirects, a kv store for sharing data between frames, 
    // and a wanix port factory for registering and handing off wanix ports to other frames
    let factory = undefined;
    let storage = new Map();
    window.onmessage = (event) => {
      if (event.data.type === "store") {
        // console.log('store', event.data.token, event.data.value);
        storage.set(event.data.token, {
          value: event.data.value,
          transfers: event.data.transfers || []
        });
        return;
      }
      if (event.data.type === "load") {
        const obj = storage.get(event.data.token);
        if (!obj) {
          console.warn("no value found for token", event.data.token);
          return;
        }
        // console.log('load', event.data.token, value);
        event.data.reply.postMessage(obj, obj.transfers);
        storage.delete(event.data.token);
        return;
      }
      // factory is a port that can be used to create a new port
      if (event.data.factory) {
        factory = event.data.factory;
        return;
      }
      // we need to send the port to the factory to create a new port.
      if (event.data.service === "wanix") {
        if (!factory) {
          console.warn("no factory found");
          return;
        }
        factory.postMessage({ port: event.data.port }, [event.data.port]);
        return;
      }

      if (!event.origin.endsWith(appHost())) {
        return;
      }
      if (event.data.redirect) {
        window.location.href = event.data.redirect;
        return;
      }
      if (event.data.self && event.data.reply) {
        event.data.reply.postMessage(window.location.href);
        return;
      }
    }

    // console.log("top frame origin", location.origin);
  </script>
</head>

<body>
  <!-- injected environment iframe -->
</body>

</html>