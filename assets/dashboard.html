<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Apptron</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="/lib/topbar.js" type="module"></script>
  <script src="/lib/dropdown.js" type="module"></script>
  <script type="module">
    import { getAuth, secondsSince, urlFor } from "/lib/apptron.js";
    const auth = await getAuth();
    window.user = await auth.getUser();
    // this could be optimized to only PUT within a 
    // certain time since creation to avoid excessive PUTs
    // ie: secondsSince(user.created_at)
    fetch(urlFor("/", {}, window.user.username), {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(window.user)
    });

    const resp = await fetch(urlFor("/projects", {}, window.user.username));
    const projects = await resp.json();
    populateProjectsGrid(projects);
  </script>
</head>

<body>
  <div style="height: 35px;">
    <apptron-topbar></apptron-topbar>
  </div>

  <div class="container">
    <header>
      <h1>Projects</h1>
      <button id="create-btn" class="create-btn" type="button">Create Project</button>
    </header>

    <div class="projects-grid" id="projects-grid">
      <!-- Projects will be populated dynamically -->
    </div>
  </div>


  <dialog id="project-dialog">
    <form id="project-form" method="dialog" class="dialog">
      <div class="dialog-header">
        <h2 id="project-dialog-title">New Project</h2>
        <button class="dialog-close" type="button" data-action="close" aria-label="Close">&times;</button>
      </div>

    <div class="dialog-body">
      <label for="project-name">Project name</label>
      <input id="project-name" name="project-name" type="text"
             pattern="[A-Za-z][A-Za-z0-9_\-]{1,23}"
             oninput="this.value = this.value.replace(/[^A-Za-z0-9_\-]/g, '')"
             title="Names can only contain letters, numbers, dashes, and underscores"
             required />

      <label for="project-desc">Description</label>
      <textarea id="project-desc" name="description" rows="4"></textarea>
    </div>

      <div class="dialog-footer">
        <button class="btn" type="button" data-action="close">Cancel</button>
        <button class="btn primary" id="project-submit" type="submit">Create</button>
      </div>
    </form>
  </dialog>



<script type="module">
  import { urlFor, redirectTo } from "/lib/apptron.js";
  
  // Template function to create a project card
  function createProjectCard(project, index) {
    const menuId = `menu-${index}`;
    const description = project.description || project.desc || 'No description available';
    const timeText = formatProjectTime(project);

    return `
        <div class="project-card">
          <div class="card-header">
            <h2 class="title"><a style="text-decoration: none; color: inherit;" href="${urlFor(`/edit/${project.name}`, {}, window.user.username)}">${escapeHtml(project.name)}</a></h2>
            <apptron-dropdown align="right">
              <button class="ellipsis-btn" type="button"
                      style="padding: 4px;">⋮</button>
              <div class="card-menu" popover role="menu" aria-label="Project menu">
                <button class="menu-item" role="menuitem" data-action="edit" data-project="${project.name}">Edit Settings</button>
                <button class="menu-item danger" role="menuitem" data-action="delete" data-project="${project.name}">Delete Project</button>
              </div>
            </apptron-dropdown>
          </div>
          <p class="desc">${escapeHtml(description)}</p>
          <span class="time">${escapeHtml(timeText)}</span>
        </div>
    `;
  }

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Format project time
  function formatProjectTime(project) {
    if (project.updated_at || project.modified || project.lastModified) {
      const date = new Date(project.updated_at || project.modified || project.lastModified);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

      if (diffDays === 0) {
        if (diffHours === 0) {
          return 'Just now';
        } else if (diffHours === 1) {
          return '1 hour ago';
        } else {
          return `${diffHours} hours ago`;
        }
      } else if (diffDays === 1) {
        return '1 day ago';
      } else if (diffDays < 7) {
        return `${diffDays} days ago`;
      } else if (diffDays < 30) {
        const weeks = Math.floor(diffDays / 7);
        return weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;
      } else {
        return date.toLocaleDateString();
      }
    }
    return 'Recently';
  }

  // Populate the projects grid
  function populateProjectsGrid(projects) {
    const grid = document.getElementById('projects-grid');
    if (!grid) return;

    if (!projects || projects.length === 0) {
      grid.innerHTML = '<p class="no-projects">No projects found. Create your first project!</p>';
      return;
    }

    const cardsHtml = projects.map((project, index) => createProjectCard(project, index)).join('');
    grid.innerHTML = cardsHtml;

      document.querySelectorAll('.project-card .menu-item').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const action = e.target.dataset.action;
          const projectName = e.target.dataset.project;
          
          
          if (action === 'edit') {

            // 1) Compute description first
            const card = e.target.closest('.project-card');
            const rawDesc = card?.querySelector('.desc')?.textContent?.trim() || '';
            const description = (rawDesc === 'No description available') ? '' : rawDesc;

            // 2) Set originalName before using it anywhere
            originalName = projectName;

            // 3) Prefill + open dialog
            form.reset();
            dlg.dataset.mode = "edit";
            titleEl.textContent  = "Edit Project";
            submitEl.textContent = "Save";
            nameInput.disabled = true;        // lock rename for now (optional)
            nameInput.value    = projectName;
            descInput.value    = description;

            dlg.showModal();
            setTimeout(() => descInput.focus(), 0);

          } else if (action === 'delete') {
            const confirmed = confirm("Are you sure you want to delete this project?");
            if (confirmed) {
              const resp = await fetch(urlFor(`/projects/${projectName}`, {}, window.user.username), {
                method: "DELETE",
              });
              if (resp.ok) {
                const resp = await fetch(urlFor("/projects", {}, window.user.username));
                const projects = await resp.json();
                populateProjectsGrid(projects);
              }
            }
          }
          e.target.parentElement.hidePopover();
      });
    });
  }

  // Expose globally
  window.populateProjectsGrid = populateProjectsGrid;

  // === New Project dialog logic ===
  function modalDialog(el) {
    const closers = el.querySelectorAll('[data-action="close"]');
    closers.forEach(closer => {
      closer.addEventListener("click", () => el.close());
    });
    el.addEventListener("click", (e) => {
      const r = el.getBoundingClientRect();
      const inBounds = (
        e.clientX >= r.left &&
        e.clientX <= r.right &&
        e.clientY >= r.top &&
        e.clientY <= r.bottom
      );
      if (!inBounds) el.close();
    });
    return el;
  }


  // === Project dialog controller (create + edit) ===
  const createBtn   = document.getElementById("create-btn");
  const dlg         = document.getElementById("project-dialog");
  const form        = document.getElementById("project-form");
  const titleEl     = document.getElementById("project-dialog-title");
  const submitEl    = document.getElementById("project-submit");
  const nameInput   = document.getElementById("project-name");
  const descInput   = document.getElementById("project-desc");

  // set up close button behavior
  modalDialog(dlg);

  // track which project we’re editing (for PATCH/PUT)
  let originalName = null;

  // open in CREATE mode
  function openCreateDialog() {
    form.reset();
    dlg.dataset.mode = "create";
    originalName = null;
    titleEl.textContent  = "New Project";
    submitEl.textContent = "Create";
    nameInput.disabled = false; // allow naming on create
    dlg.showModal();
    setTimeout(() => nameInput.focus(), 0);
  }

  // open in EDIT mode (prefill fields)
  function openEditDialog(project) {
    form.reset();
    dlg.dataset.mode = "edit";
    originalName = project.name;
    titleEl.textContent  = "Edit Project";
    submitEl.textContent = "Save";
    nameInput.value = project.name;
    descInput.value = project.description || project.desc || "";
    // If you DON’T allow renaming in edit, lock it:
    // nameInput.disabled = true;
    dlg.showModal();
    setTimeout(() => descInput.focus(), 0);
  }

  createBtn.addEventListener("click", openCreateDialog);

  

// === Submit handler for create AND edit === //
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = (nameInput.value || "").trim();
    const description = (descInput.value || "").trim();
    if (!name || !nameInput.checkValidity()) { nameInput.focus(); return; }

    try {
      if (dlg.dataset.mode === "edit") {
        const targetName = originalName || (nameInput.value || "").trim();
        if (!targetName) { alert("No project name to update."); return; }

        // troubleshooting whether the new description is in the put request...
        console.log('PUT →', originalName, (descInput.value || '').trim());

        const resp = await fetch(
          urlFor(`/projects/${encodeURIComponent(targetName)}`, {}, window.user.username),
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ description: (descInput.value || "").trim() })
          }
        );

        if (!resp.ok) throw new Error("Failed to update project");

        dlg.close();
        // Refresh list so the new description shows
        const listResp = await fetch(urlFor("/projects", {}, window.user.username));
        const projects = await listResp.json();
        populateProjectsGrid(projects);
        return;
      } else {
        // === Create new project ===
        const resp = await fetch(urlFor("/projects", {}, window.user.username), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, description })
        });
        if (!resp.ok) throw new Error("Failed to create project");
        redirectTo(resp.headers.get("Location"));
      }
    } catch (err) {
      alert(err.message || "Something went wrong");
    }
  });
  </script>

</body>
</html>