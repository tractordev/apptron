<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Apptron</title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <script src="/lib/html-component.js" type="module"></script>
  <script src="/lib/dropdown.js" type="module"></script>
  <script type="module">
    import { getAuth, secondsSince, urlFor } from "/lib/apptron.js";
  
    const auth = await getAuth();
    window.user = await auth.getUser();
    // this could be optimized to only PUT within a 
    // certain time since creation to avoid excessive PUTs
    // ie: secondsSince(user.created_at)
    fetch(urlFor("/", {}, window.user.username), {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(window.user)
    });

    const resp = await fetch(urlFor("/projects", {}, window.user.username));
    const projects = await resp.json();
    populateProjectsGrid(projects);
  </script>
</head>

<body>
  <div class="header-container">
    <html-component src="/com/topbar"></html-component>
  </div>

  <div class="container">
    <header>
      <h1>Projects</h1>
      <button id="create-btn" class="create-btn btn primary" type="button"><span>Create Project</span>
    </button>
    </header>

    <div class="projects-grid" id="projects-grid">
      <!-- Projects will be populated dynamically -->
    </div>
  </div>

<script type="module">
  import { urlFor, redirectTo, modalDialog, $, $$, getBundle } from "/lib/apptron.js";
  
  $("#create-btn").addEventListener("click", async () => {
    const resp = await window.modal.show("/com/project", {});
    if (!resp) return; // canceled
    if (!resp.ok) {
      alert("Failed to create project");
      return;
    }
    redirectTo(resp.headers.get("Location"));
  });

  // Template function to create a project card
  function createProjectCard(project, index) {
    const menuId = `menu-${index}`;
    const description = project.description || 'No description available';
    const timeText = formatProjectTime(project);

    return `
        <div class="project-card" data-url="${urlFor(`/edit/${project.name}`, {}, window.user.username)}">
          <div class="card-header">
            <h2 class="title"><a style="text-decoration: none; color: inherit;" href="${urlFor(`/edit/${project.name}`, {}, window.user.username)}">${escapeHtml(project.name)}</a></h2>
            <apptron-dropdown align="right">
              <button class="ellipsis-btn btn" type="button">â‹®</button>
              <div class="card-menu" popover role="menu" aria-label="Project menu">
                <button class="menu-item btn" role="menuitem" data-action="edit" data-project="${escapeJSON(JSON.stringify(project))}">Edit Settings</button>
                <button class="menu-item danger btn" role="menuitem" data-action="delete" data-project="${escapeJSON(JSON.stringify(project))}">Delete Project</button>
              </div>
            </apptron-dropdown>
          </div>
          <p class="desc">${escapeHtml(description)}</p>
          <span class="time">${escapeHtml(timeText)}</span>
        </div>
    `;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function escapeJSON(json) {
    return json.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function formatProjectTime(project) {
    if (project.updated_at || project.modified || project.lastModified) {
      const date = new Date(project.updated_at || project.modified || project.lastModified);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

      if (diffDays === 0) {
        if (diffHours === 0) {
          return 'Just now';
        } else if (diffHours === 1) {
          return '1 hour ago';
        } else {
          return `${diffHours} hours ago`;
        }
      } else if (diffDays === 1) {
        return '1 day ago';
      } else if (diffDays < 7) {
        return `${diffDays} days ago`;
      } else if (diffDays < 30) {
        const weeks = Math.floor(diffDays / 7);
        return weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;
      } else {
        return date.toLocaleDateString();
      }
    }
    return 'Recently';
  }

  // Populate the projects grid
  function populateProjectsGrid(projects) {
    const grid = document.getElementById('projects-grid');
    if (!grid) return;

    if (!projects || projects.length === 0) {
      grid.innerHTML = '<p class="no-projects">No projects found. Create your first project!</p>';
      return;
    }

    const cardsHtml = projects.map((project, index) => createProjectCard(project, index)).join('');
    grid.innerHTML = cardsHtml;

    $$('.project-card .menu-item').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const action = e.target.dataset.action;
        const project = JSON.parse(e.target.dataset.project);
        const projectName = project.name;
        
        if (action === 'edit') {
          const resp = await window.modal.show("/com/project", {project});
          if (!resp) return; // canceled
          if (!resp.ok) {
            alert("Failed to update project");
            return;
          }
          // Refresh list so the new description shows
          const listResp = await fetch(urlFor("/projects", {}, window.user.username));
          const projects = await listResp.json();
          populateProjectsGrid(projects);

        } else if (action === 'delete') {
          const confirmed = confirm("Are you sure you want to delete this project?");
          if (confirmed) {
            const resp = await fetch(urlFor(`/projects/${projectName}`, {}, window.user.username), {
              method: "DELETE",
            });
            if (resp.ok) {
              const resp = await fetch(urlFor("/projects", {}, window.user.username));
              const projects = await resp.json();
              populateProjectsGrid(projects);
            }
          }
        }
        e.target.parentElement.hidePopover();
      });
    });
  }
  // Expose globally (used in another script)
  window.populateProjectsGrid = populateProjectsGrid;

   // make the whole card clickable 
  const gridEl = $("#projects-grid");

  gridEl.addEventListener("click", (e) => {
    // Ignore clicks inside the dropdown / menu
    if (e.target.closest("apptron-dropdown")) return;
    if (e.target.closest(".menu-item")) return;

    const card = e.target.closest(".project-card");
    if (!card) return;

    const url = card.dataset.url;
    if (!url) return;

    redirectTo(url); // or window.location.href = url;
  });



  // start pre-loading common bundles
  getBundle("/bundles/sys.tar.gz");
  getBundle("/bundles/goroot.tar.br");
  getBundle("/bundles/gocache-386.tar.br");
</script>

<div id="toast-root">
    <div class="toast">
        <svg class="toast-status-icon" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M9.63895 1.15984C11.4291 1.33886 13.0989 2.14309 14.3549 3.43121C15.7233 4.82126 16.5323 6.66622 16.6277 8.61442C16.7232 10.5626 16.0984 12.4778 14.8724 13.995C13.7449 15.3965 12.1626 16.3594 10.3997 16.7169C8.63682 17.0745 6.8044 16.804 5.21995 15.9525C3.6321 15.0825 2.39252 13.6919 1.70995 12.015C1.02432 10.3294 0.933066 8.46058 1.4512 6.71621C1.96822 4.97864 3.06889 3.47266 4.56745 2.45246C6.0534 1.43874 7.84905 0.981061 9.63895 1.15984ZM10.1699 15.615C11.6806 15.3086 13.0372 14.485 14.0062 13.2862C15.0554 11.9823 15.5892 10.3384 15.5062 8.66685C15.4233 6.99527 14.7293 5.41236 13.5562 4.21871C12.4817 3.12185 11.0558 2.43752 9.52792 2.28535C8 2.13317 6.4672 2.52283 5.19745 3.38621C4.24169 4.04478 3.46989 4.93646 2.95518 5.97678C2.44047 7.0171 2.19988 8.1716 2.25621 9.33092C2.31255 10.4902 2.66393 11.616 3.27708 12.6015C3.89023 13.587 4.74484 14.3997 5.75995 14.9625C7.10806 15.69 8.6689 15.921 10.1699 15.615ZM8.29682 6.74996H9.70307V5.62496H8.29682V6.74996ZM9.70307 7.87496V12.375H8.29682V7.87496H9.70307Z" fill="currentColor"/>
        </svg>
        <span class="toast-text">Project deleted. Here's what it looks like if there is more text, possibly more text that would wrap onto the next line.</span>
        <button type="button" aria-label="Close">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M9.00015 9.79543L13.1019 13.8983L13.8984 13.1029L9.79553 9.00006L13.8984 4.89831L13.103 4.10181L9.00015 8.20468L4.8984 4.10181L4.10303 4.89831L8.20478 9.00006L4.10303 13.1018L4.8984 13.8983L9.00015 9.79543Z" fill="currentColor"/>
            </svg>
        </button>
    </div>
</div>

</body>
</html>
