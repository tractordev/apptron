<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Apptron</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="/lib/topbar.js" type="module"></script>
  <script src="/lib/dropdown.js" type="module"></script>
  <script type="module">
    import { getAuth, secondsSince, urlFor } from "/lib/apptron.js";
    const auth = await getAuth();
    window.user = await auth.getUser();
    // this could be optimized to only PUT within a 
    // certain time since creation to avoid excessive PUTs
    // ie: secondsSince(user.created_at)
    fetch(urlFor("/", {}, window.user.username), {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(window.user)
    });

    const resp = await fetch(urlFor("/projects", {}, window.user.username));
    const projects = await resp.json();
    populateProjectsGrid(projects);
  </script>
</head>

<body>
  <div style="height: 35px;">
    <apptron-topbar></apptron-topbar>
  </div>

  <div class="container">
    <header>
      <h1>Projects</h1>
      <button id="create-btn" class="create-btn" type="button">Create Project</button>
    </header>

    <div class="projects-grid" id="projects-grid">
      <!-- Projects will be populated dynamically -->
    </div>
  </div>


  <dialog id="new-project-dialog">
    <form id="new-project-form" method="dialog" class="dialog">
      <div class="dialog-header">
        <h2>New Project</h2>
        <button class="dialog-close" type="button" aria-label="Close">&times;</button>
      </div>

      <div class="dialog-body">
        <label for="project-name">Project name</label>
        <input  id="project-name" 
                name="project-name" 
                type="text" 
                pattern="[A-Za-z][A-Za-z0-9_\-]{1,23}" 
                oninput="this.value = this.value.replace(/[^A-Za-z0-9_\-]/g, '')" 
                title="Names can only contain letters, numbers, dashes, and underscores"
                required />

        <label for="project-desc">Description</label>
        <textarea id="project-desc" name="description" rows="4"></textarea>
      </div>

      <div class="dialog-footer">
        <button class="btn" type="button" data-action="cancel">Cancel</button>
        <button class="btn primary" type="submit">Create</button>
      </div>
    </form>
  </dialog>



<script type="module">
  import { urlFor, redirectTo } from "/lib/apptron.js";
  
  // Template function to create a project card
  function createProjectCard(project, index) {
    const menuId = `menu-${index}`;
    const description = project.description || project.desc || 'No description available';
    const timeText = formatProjectTime(project);

    return `
        <div class="project-card">
          <div class="card-header">
            <h2 class="title"><a style="text-decoration: none; color: inherit;" href="${urlFor(`/edit/${project.name}`, {}, window.user.username)}">${escapeHtml(project.name)}</a></h2>
            <apptron-dropdown align="right">
              <button class="ellipsis-btn" type="button"
                      style="padding: 4px;">â‹®</button>
              <div class="card-menu" popover role="menu" aria-label="Project menu">
                <button class="menu-item" role="menuitem" data-action="edit" data-project="${project.name}">Edit Settings</button>
                <button class="menu-item danger" role="menuitem" data-action="delete" data-project="${project.name}">Delete Project</button>
              </div>
            </apptron-dropdown>
          </div>
          <p class="desc">${escapeHtml(description)}</p>
          <span class="time">${escapeHtml(timeText)}</span>
        </div>
    `;
  }

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Format project time
  function formatProjectTime(project) {
    if (project.updated_at || project.modified || project.lastModified) {
      const date = new Date(project.updated_at || project.modified || project.lastModified);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

      if (diffDays === 0) {
        if (diffHours === 0) {
          return 'Just now';
        } else if (diffHours === 1) {
          return '1 hour ago';
        } else {
          return `${diffHours} hours ago`;
        }
      } else if (diffDays === 1) {
        return '1 day ago';
      } else if (diffDays < 7) {
        return `${diffDays} days ago`;
      } else if (diffDays < 30) {
        const weeks = Math.floor(diffDays / 7);
        return weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;
      } else {
        return date.toLocaleDateString();
      }
    }
    return 'Recently';
  }

  // Populate the projects grid
  function populateProjectsGrid(projects) {
    const grid = document.getElementById('projects-grid');
    if (!grid) return;

    if (!projects || projects.length === 0) {
      grid.innerHTML = '<p class="no-projects">No projects found. Create your first project!</p>';
      return;
    }

    const cardsHtml = projects.map((project, index) => createProjectCard(project, index)).join('');
    grid.innerHTML = cardsHtml;

      document.querySelectorAll('.project-card .menu-item').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const action = e.target.dataset.action;
          const projectName = e.target.dataset.project;
          if (action === 'edit') {
            console.log("todo: edit", projectName);

          } else if (action === 'delete') {
            const confirmed = confirm("Are you sure you want to delete this project?");
            if (confirmed) {
              const resp = await fetch(urlFor(`/projects/${projectName}`, {}, window.user.username), {
                method: "DELETE",
              });
              if (resp.ok) {
                const resp = await fetch(urlFor("/projects", {}, window.user.username));
                const projects = await resp.json();
                populateProjectsGrid(projects);
              }
            }
          }
          e.target.parentElement.hidePopover();
      });
    });
  }

  // Expose globally
  window.populateProjectsGrid = populateProjectsGrid;

  // === New Project dialog logic ===
  const createBtn = document.getElementById("create-btn");
  const dlg = document.getElementById("new-project-dialog");
  const form = document.getElementById("new-project-form");
  const closeBtn = dlg.querySelector(".dialog-close");
  const cancelBtn = dlg.querySelector('[data-action="cancel"]');
  const nameInput = document.getElementById("project-name");
  const descInput = document.getElementById("project-desc");

  createBtn.addEventListener("click", () => {
    form.reset();
    dlg.showModal();
    setTimeout(() => nameInput.focus(), 0);
  });

  function closeDialog() {
    if (dlg.open) dlg.close();
  }

  closeBtn.addEventListener("click", closeDialog);
  cancelBtn.addEventListener("click", closeDialog);

  dlg.addEventListener("click", (e) => {
    const r = dlg.getBoundingClientRect();
    const inBounds = e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom;
    if (!inBounds) closeDialog();
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = nameInput.value.trim();
    const description = (descInput.value || "").trim();
    if (!name) { nameInput.focus(); return; }
    if (!nameInput.checkValidity()) {
      nameInput.focus();
      return;
    }

    const project = { name, description };

    const response = await fetch(urlFor("/projects", {}, window.user.username), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(project)
    });
    if (response.ok) {
      redirectTo(response.headers.get("Location"));
    } else {
      alert("Failed to create project");
    }
  });
  </script>
</body>
</html>