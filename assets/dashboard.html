<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Apptron</title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <script src="/lib/html-component.js" type="module"></script>
  <script src="/lib/dropdown.js" type="module"></script>
  <script type="module">
    import { getAuth, secondsSince, urlFor } from "/lib/apptron.js";
  
    const auth = await getAuth();
    window.user = await auth.getUser();
    // this could be optimized to only PUT within a 
    // certain time since creation to avoid excessive PUTs
    // ie: secondsSince(user.created_at)
    fetch(urlFor("/", {}, window.user.username), {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(window.user)
    });

    const resp = await fetch(urlFor("/projects", {}, window.user.username));
    const projects = await resp.json();
    populateProjectsGrid(projects);
  </script>
</head>

<body>
  <div class="header-container">
    <html-component src="/com/topbar"></html-component>
  </div>

  <div class="container">
    <header>
      <h1>Projects</h1>
      <button id="create-btn" class="create-btn btn primary" type="button"><span>Create Project</span>
    </button>
    </header>

    <div class="projects-grid" id="projects-grid">
      <!-- Projects will be populated dynamically -->
    </div>
  </div>

<script type="module">
  import { urlFor, redirectTo, modalDialog, $, $$, getBundle } from "/lib/apptron.js";
  
  $("#create-btn").addEventListener("click", async () => {
    const resp = await window.modal.show("/com/project", {});
    if (!resp) return; // canceled
    if (!resp.ok) {
      alert("Failed to create project");
      return;
    }
    redirectTo(resp.headers.get("Location"));
  });

  // Template function to create a project card
  function createProjectCard(project, index) {
    const menuId = `menu-${index}`;
    const description = project.description || 'No description available';
    const timeText = formatProjectTime(project);

    return `
        <div class="project-card" data-url="${urlFor(`/edit/${project.name}`, {}, window.user.username)}">
          <div class="card-header">
            <h2 class="title"><a style="text-decoration: none; color: inherit;" href="${urlFor(`/edit/${project.name}`, {}, window.user.username)}">${escapeHtml(project.name)}</a></h2>
            <apptron-dropdown align="right">
              <button class="ellipsis-btn btn" type="button">â‹®</button>
              <div class="card-menu" popover role="menu" aria-label="Project menu">
                <button class="menu-item btn" role="menuitem" data-action="edit" data-project="${escapeJSON(JSON.stringify(project))}">Edit Settings</button>
                <button class="menu-item danger btn" role="menuitem" data-action="delete" data-project="${escapeJSON(JSON.stringify(project))}">Delete Project</button>
              </div>
            </apptron-dropdown>
          </div>
          <p class="desc">${escapeHtml(description)}</p>
          <span class="time">${escapeHtml(timeText)}</span>
        </div>
    `;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function escapeJSON(json) {
    return json.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function formatProjectTime(project) {
    if (project.updated_at || project.modified || project.lastModified) {
      const date = new Date(project.updated_at || project.modified || project.lastModified);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

      if (diffDays === 0) {
        if (diffHours === 0) {
          return 'Just now';
        } else if (diffHours === 1) {
          return '1 hour ago';
        } else {
          return `${diffHours} hours ago`;
        }
      } else if (diffDays === 1) {
        return '1 day ago';
      } else if (diffDays < 7) {
        return `${diffDays} days ago`;
      } else if (diffDays < 30) {
        const weeks = Math.floor(diffDays / 7);
        return weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;
      } else {
        return date.toLocaleDateString();
      }
    }
    return 'Recently';
  }

  // Populate the projects grid
  function populateProjectsGrid(projects) {
    const grid = document.getElementById('projects-grid');
    if (!grid) return;

    if (!projects || projects.length === 0) {
      grid.innerHTML = '<p class="no-projects">No projects found. Create your first project!</p>';
      return;
    }

    const cardsHtml = projects.map((project, index) => createProjectCard(project, index)).join('');
    grid.innerHTML = cardsHtml;

    $$('.project-card .menu-item').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const action = e.target.dataset.action;
        const project = JSON.parse(e.target.dataset.project);
        const projectName = project.name;
        
        if (action === 'edit') {
          const resp = await window.modal.show("/com/project", {project});
          if (!resp) return; // canceled
          if (!resp.ok) {
            alert("Failed to update project");
            return;
          }
          // Refresh list so the new description shows
          const listResp = await fetch(urlFor("/projects", {}, window.user.username));
          const projects = await listResp.json();
          populateProjectsGrid(projects);

        } else if (action === 'delete') {
          const confirmed = confirm("Are you sure you want to delete this project?");
          if (confirmed) {
            const resp = await fetch(urlFor(`/projects/${projectName}`, {}, window.user.username), {
              method: "DELETE",
            });
            if (resp.ok) {
              const resp = await fetch(urlFor("/projects", {}, window.user.username));
              const projects = await resp.json();
              populateProjectsGrid(projects);
            }
          }
        }
        e.target.parentElement.hidePopover();
      });
    });
  }
  // Expose globally (used in another script)
  window.populateProjectsGrid = populateProjectsGrid;

   // make the whole card clickable 
  const gridEl = $("#projects-grid");

  gridEl.addEventListener("click", (e) => {
    // Ignore clicks inside the dropdown / menu
    if (e.target.closest("apptron-dropdown")) return;
    if (e.target.closest(".menu-item")) return;

    const card = e.target.closest(".project-card");
    if (!card) return;

    const url = card.dataset.url;
    if (!url) return;

    redirectTo(url); // or window.location.href = url;
  });



  // start pre-loading common bundles
  getBundle("/bundles/sys.tar.gz");
  getBundle("/bundles/goroot.tar.br");
  getBundle("/bundles/gocache-386.tar.br");
</script>

<div id="toast-root">
    <div class="toast">
        Project deleted
    </div>
</div>

</body>
</html>
