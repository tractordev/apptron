<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Apptron</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="topbar/topbar.js" type="module"></script>
  <script type="module">
    import { getAuth, secondsSince, urlFor } from "/apptron.js";
    const auth = await getAuth();
    window.user = await auth.getUser();
    // this could be optimized to only PUT within a 
    // certain time since creation to avoid excessive PUTs
    // ie: secondsSince(user.created_at)
    fetch(urlFor("/", {}, window.user.username), {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(window.user)
    });

    const resp = await fetch(urlFor("/projects", {}, window.user.username));
    const projects = await resp.json();
    populateProjectsGrid(projects);
  </script>
</head>

<body>
  <div style="height: 35px;">
    <apptron-topbar></apptron-topbar>
  </div>

  <div class="container">
    <header>
      <h1>Projects</h1>
      <button id="create-btn" class="create-btn" type="button">Create Project</button>
    </header>

    <div class="projects-grid" id="projects-grid">
      <!-- Projects will be populated dynamically -->
    </div>
  </div>
  <script type="module">
    import { urlFor, redirectTo } from "/apptron.js";
    
    // Template function to create a project card
    function createProjectCard(project, index) {
      const menuId = `menu-${index}`;
      const description = project.description || project.desc || 'No description available';
      const timeText = formatProjectTime(project);
      
      return `
        <div class="project-card">
          <div class="card-header">
            <h2 class="title"><a style="text-decoration: none; color: inherit;" href="${urlFor(`/edit/${project.name}`, {}, window.user.username)}">${escapeHtml(project.name)}</a></h2>
            <button class="ellipsis-btn" type="button"
                    style="padding: 0 4px 0 4px;"
                    aria-haspopup="menu" aria-controls="${menuId}"
                    popovertarget="${menuId}" popovertargetaction="toggle">â‹®</button>
            <div id="${menuId}" class="card-menu" popover role="menu" aria-label="Project menu">
              <button class="menu-item" role="menuitem" data-action="edit" data-project="${project.name}">Edit Settings</button>
              <button class="menu-item danger" role="menuitem" data-action="delete" data-project="${project.name}">Delete Project</button>
            </div>
          </div>
          <p class="desc">${escapeHtml(description)}</p>
          <span class="time">${escapeHtml(timeText)}</span>
        </div>
      `;
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Helper function to format project time
    function formatProjectTime(project) {
      if (project.updated_at || project.modified || project.lastModified) {
        const date = new Date(project.updated_at || project.modified || project.lastModified);
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        
        if (diffDays === 0) {
          if (diffHours === 0) {
            return 'Just now';
          } else if (diffHours === 1) {
            return '1 hour ago';
          } else {
            return `${diffHours} hours ago`;
          }
        } else if (diffDays === 1) {
          return '1 day ago';
        } else if (diffDays < 7) {
          return `${diffDays} days ago`;
        } else if (diffDays < 30) {
          const weeks = Math.floor(diffDays / 7);
          return weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;
        } else {
          return date.toLocaleDateString();
        }
      }
      return 'Recently';
    }
    
    // Function to populate the projects grid
    function populateProjectsGrid(projects) {
      const grid = document.getElementById('projects-grid');
      if (!grid) return;
      
      if (!projects || projects.length === 0) {
        grid.innerHTML = '<p class="no-projects">No projects found. Create your first project!</p>';
        return;
      }
      
      const cardsHtml = projects.map((project, index) => createProjectCard(project, index)).join('');
      grid.innerHTML = cardsHtml;
      document.querySelectorAll('.project-card .card-menu').forEach(popover => {
        popover.addEventListener('toggle', (e) => {
          if (e.newState !== 'open') return;

          const triggerRect = e.source.getBoundingClientRect();
          const popoverRect = popover.getBoundingClientRect();

          // Align right side of popover with right side of trigger
          // and top of popover with bottom of trigger
          const marginLeft = triggerRect.right - popoverRect.width;
          const marginTop = triggerRect.bottom;

          popover.style.marginLeft = `${marginLeft}px`;
          popover.style.marginTop = `${marginTop}px`;
        });
      });
      document.querySelectorAll('.project-card .menu-item').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const action = e.target.dataset.action;
          const projectName = e.target.dataset.project;
          if (action === 'edit') {
            console.log("todo: edit", projectName);

          } else if (action === 'delete') {
            const confirmed = confirm("Are you sure you want to delete this project?");
            if (confirmed) {
              const resp = await fetch(urlFor(`/projects/${projectName}`, {}, window.user.username), {
                method: "DELETE",
              });
              if (resp.ok) {
                const resp = await fetch(urlFor("/projects", {}, window.user.username));
                const projects = await resp.json();
                populateProjectsGrid(projects);
              }
            }
          }
          e.target.parentElement.hidePopover();
        });
      });
    }
    
    // Make function available globally
    window.populateProjectsGrid = populateProjectsGrid;
    document.getElementById("create-btn").addEventListener("click", async () => {
      const name = prompt("Enter a name for your project");
      if (!name) {
        return;
      }
      const project = {name};
      const response = await fetch(urlFor("/projects", {}, window.user.username), {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(project)
      });
      if (response.ok) {
        // Refresh the projects list
        const resp = await fetch(urlFor("/projects", {}, window.user.username));
        const projects = await resp.json();
        populateProjectsGrid(projects);
        
        // Optionally redirect to the new project
        redirectTo(response.headers.get("Location"));
      } else {
        alert("Failed to create project");
      }
    });
  </script>
</body>
</html>