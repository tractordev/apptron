<html>
<style>
  @import url("/styles.css");

  :host {
    display: block;
  }
</style>
<script type="module">
  import { redirectTo, urlFor } from "/lib/apptron.js";

  const form        = $("#project-form");
  const titleEl     = $("#project-dialog-title");
  const submitEl    = $("#project-submit");
  const nameInput   = $("#project-name");
  const descInput   = $("#project-desc");

  form.reset();

  const project = component.context.project;
  // todo: should probably fetch the project from 
  // the server to get the latest description to avoid stale data
  // and avoid the need to reload the page
  if (project) {
    titleEl.innerText = "Edit Project";
    submitEl.innerText = "Save";
    nameInput.value = project.name;
    descInput.value = project.description || project.desc || "";
    nameInput.disabled = true;
    setTimeout(() => descInput.focus(), 0);

  } else {
    titleEl.innerText = "New Project";
    submitEl.innerText = "Create";
    nameInput.disabled = false; // allow naming on create
    setTimeout(() => nameInput.focus(), 0);
    
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = (nameInput.value || "").trim();
    const description = (descInput.value || "").trim();
    if (!name || !nameInput.checkValidity()) { nameInput.focus(); return; }

    const resp = (project) 
      ? await fetch(urlFor(`/projects/${encodeURIComponent(project.name)}`, {}, window.session.claims.username), {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ description: (descInput.value || "").trim() })
        })
      : await fetch(urlFor("/projects", {}, window.session.claims.username), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, description })
        });
    
    window.modal.finish(resp);

  });
</script>
<form id="project-form" method="dialog" class="dialog">
  <div class="dialog-header">
    <h2 id="project-dialog-title">New Project</h2>
    <button class="dialog-close" type="button" onclick="window.modal.finish()" aria-label="Close">&times;</button>
  </div>

  <div class="dialog-body">
    <label for="project-name">Project name</label>
    <input id="project-name" name="project-name" type="text" pattern="[A-Za-z][A-Za-z0-9_\-]{1,23}"
      oninput="this.value = this.value.replace(/[^A-Za-z0-9_\-]/g, '')"
      title="Names can only contain letters, numbers, dashes, and underscores" required />

    <label for="project-desc">Description</label>
    <textarea id="project-desc" name="description" rows="4"></textarea>

    <fieldset class="visibility-group" role="radiogroup" aria-labelledby="visibility-legend">
      <legend id="visibility-legend">Visibility</legend>

      <label class="radio-option" for="vis-public">
        <input type="radio" id="vis-public" name="visibility" value="public" aria-describedby="vis-public-help">
        <span class="option-title">Public</span>
        <span id="vis-public-help" class="option-help">
          Anyone with a link has View access
        </span>
      </label>
      <label class="radio-option" for="vis-private">
        <input type="radio" id="vis-private" name="visibility" value="private" checked
          aria-describedby="vis-private-help">
        <span class="option-title">Private ðŸ”’</span>
        <span id="vis-private-help" class="option-help">
          Only people you've directly invited can access this project
        </span>
      </label>
    </fieldset>
  </div>

  <div class="dialog-footer">
    <button class="btn" type="button" onclick="window.modal.finish()">Cancel</button>
    <button class="btn primary" id="project-submit" type="submit">Create</button>
  </div>
</form>
</html>