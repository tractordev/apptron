<html>
<style>
    @import url("/styles.css");
    :host { display: block; }
</style>
<script type="module">
    import { urlFor, getAuth, copyText, currentURL, envUsername, isLocalhost } from "/lib/apptron.js";
    const { project } = component?.context || {};

    async function publishURL() {
        const username = await envUsername();
        // todo: dont hardcode the publish domain for prod
        const publicURL = `${username}.aptn.pub/${project.name}`;
        if (isLocalhost()) {
            return `http://${window.location.host}/${publicURL}`;
        }
        return `https://${publicURL}`;
    }

    async function checkPublishSource() {
        let publishSource = $("#publish-source").value.replace(/^\/+|\/+$/g, ""); // trim slashes
        if (publishSource === ".") {
            publishSource = "";
        } else {
            publishSource = "/"+publishSource;
        }
        // todo: use a port/handle rooted to the vm filesystem so this isn't needed
        const basePath = "vm/1/fsys"
        try {
            await window.apptron.instance.stat(`${basePath}/project${publishSource}`);
        } catch (error) {
            $("#publish-source-error").innerText = "Publish source does not exist";
            $("#publish-button").disabled = true;
            return false;
        }
        $("#publish-source-error").innerText = "";
        $("#publish-button").disabled = false;
        return true;
    }

    $("#copy-url").addEventListener("click", async () => {
        const ok = await copyText($("#publish-url").value || "");
        const oldText = $("#copy-url").textContent;
        $("#copy-url").textContent = ok ? "Copied!" : "Copy failed";
        setTimeout(() => ($("#copy-url").textContent = oldText), 1200);
    });

    $("#publish-url").value = await publishURL();
    $("#publish-source").value = project.publish_source || ".";
    $("#publish-source").addEventListener("change", () => checkPublishSource());
    await checkPublishSource();

    $("#publish-form").addEventListener("submit", async (e) => {
        $("#publish-button").classList.add("btn-loading");
        e.preventDefault();
        if (!await checkPublishSource()) {
            $("#publish-button").classList.remove("btn-loading");
            return;
        }
        const project = component.context.project;
        const tokenParam = { token: (await getAuth()).getSessionToken() };
        let publishSource = $("#publish-source").value.replace(/^\/+|\/+$/g, ""); // trim slashes
        const resp = await fetch(urlFor(`/projects/${project.name}`, tokenParam, window.session.claims.username), {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ publish_source: publishSource })
        });
        if (!resp.ok) {
            console.error("Error updating publish source", resp);
            return;
        }
        // todo: use a port/handle rooted to the vm filesystem so this isn't needed
        const basePath = "vm/1/fsys"
        if (publishSource === ".") {
            publishSource = "";
        } else {
            publishSource = "/"+publishSource;
        }
        await window.apptron.instance.appendFile("ctl", `sync ${basePath}/project${publishSource} ${basePath}/public`);
        window.modal.finish();
    });
</script>

<form id="publish-form" method="dialog" class="dialog">
<div class="dialog-body">
    <label for="publish-source">Source Path</label>
    <input id="publish-source" name="publish-source" type="text" spellcheck="false" />
    <span class="form-error" id="publish-source-error"></span>

    <label for="publish-url">Public URL</label>
    <input id="publish-url" type="text" readonly spellcheck="false" />
</div>

<div class="dialog-footer">
    <div style="flex-grow: 2;">
        <button id="copy-url" type="button" class="btn secondary">Copy URL</button>
    </div>
    <button class="btn primary" id="publish-button" type="submit"><span>Publish</span></button>
</div>
</form>

</html>
