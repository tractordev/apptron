<html>
<style>
    @import url("/styles.css");
    :host { display: block; }
</style>

<form id="publish-form" method="dialog" class="dialog">
<div class="dialog-body">
    <p class="mb-8">Publish syncs the source path of your project to the public mount, which is served at the Public URL.</p>
    <label for="publish-source">Source Path</label>
    <input id="publish-source" name="publish-source" type="text" spellcheck="false" />
    <span class="form-error" id="publish-source-error"></span>

    <label for="publish-url">Public URL</label>
    <div class="input-row">
        <input id="publish-url" type="text" readonly spellcheck="false" />
        <button type="button" id="copy-url" class="icon-btn secondary btn" aria-label="Copy URL" title="Copy">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M6 6L7.5 4.5H15.621L21 9.879V21L19.5 22.5H7.5L6 21V6ZM19.5 10.5L15 6H7.5V21H19.5V10.5Z" fill="white"/>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M4.5 1.5L3 3V18L4.5 19.5V3H14.121L12.621 1.5H4.5Z" fill="white"/>
            </svg>
        </button>
    </div>
</div>

<div class="dialog-footer">
    <button class="btn primary" id="publish-button" type="submit"><span>Publish</span></button>
</div>
</form>

<script type="module">
    import { urlFor, getAuth, copyText, currentURL, envUsername, isLocalhost } from "/lib/apptron.js";
    const { project } = component?.context || {};

    async function publishURL() {
        const username = await envUsername();
        // todo: dont hardcode the publish domain for prod
        const publicURL = `${username}.aptn.pub/${project.name}`;
        if (isLocalhost()) {
            return `http://${window.location.host}/${publicURL}`;
        }
        return `https://${publicURL}`;
    }

    async function checkPublishSource() {
        let publishSource = $("#publish-source").value.replace(/^\/+|\/+$/g, ""); // trim slashes
        if (publishSource === ".") {
            publishSource = "";
        } else {
            publishSource = "/"+publishSource;
        }
        // todo: use a port/handle rooted to the vm filesystem so this isn't needed
        const basePath = "vm/1/fsys"
        try {
            await window.apptron.instance.stat(`${basePath}/project${publishSource}`);
        } catch (error) {
            $("#publish-source-error").innerText = "Publish source does not exist";
            $("#publish-button").disabled = true;
            return false;
        }
        $("#publish-source-error").innerText = "";
        $("#publish-button").disabled = false;
        return true;
    }

    const CHECK_SVG = `
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M21.6464 4.98438L8.94145 19.9844L7.75645 19.9304L2.73145 12.7754L3.95845 11.9144L8.42545 18.2744L20.5019 4.01538L21.6479 4.98438H21.6464Z" fill="white"/>
    </svg>
    `;

    queueMicrotask(async () => {
        const copyBtn = $("#copy-url");
        if (copyBtn) {
            copyBtn.addEventListener("click", async () => {
                const ok = await copyText($("#publish-url").value || "");
                if (!ok) return;

                const original = copyBtn.innerHTML;
                copyBtn.innerHTML = CHECK_SVG;
                copyBtn.setAttribute("aria-label", "Copied");

                setTimeout(() => {
                    copyBtn.innerHTML = original;
                    copyBtn.setAttribute("aria-label", "Copy URL");
                }, 1200);
            });
        }
        $("#publish-url").value = await publishURL();
        $("#publish-source").value = project.publish_source || ".";
        $("#publish-source").addEventListener("change", () => checkPublishSource());
        await checkPublishSource();

        $("#publish-form").addEventListener("submit", async (e) => {
            $("#publish-button").classList.add("btn-loading");
            e.preventDefault();
            if (!await checkPublishSource()) {
                $("#publish-button").classList.remove("btn-loading");
                return;
            }
            const project = component.context.project;
            const tokenParam = { token: (await getAuth()).getSessionToken() };
            let publishSource = $("#publish-source").value.replace(/^\/+|\/+$/g, ""); // trim slashes
            const resp = await fetch(urlFor(`/projects/${project.name}`, tokenParam, window.session.claims.username), {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ publish_source: publishSource })
            });
            if (!resp.ok) {
                console.error("Error updating publish source", resp);
                return;
            }
            // todo: use a port/handle rooted to the vm filesystem so this isn't needed
            const basePath = "vm/1/fsys"
            if (publishSource === ".") {
                publishSource = "";
            } else {
                publishSource = "/"+publishSource;
            }
            await window.apptron.instance.appendFile("ctl", `sync ${basePath}/project${publishSource} ${basePath}/public`);
            window.modal.finish();
        });
    });
</script>

</html>
