<html>
<style>
    @import url("/styles.css");
    :host {
        display: block;
    }
</style>

<script type="module">
    import { urlFor, getAuth } from "/lib/apptron.js";

    // -------------------------------------------------------
    // TAB INITIALIZATION
    // -------------------------------------------------------
    queueMicrotask(() => init())

    async function init() {
        const tabShare     = $("#tab-share");
        // const tabEmbed     = $("#tab-embed");
        const tabPublish   = $("#tab-publish");

        const { project } = component?.context || {};

        // Simple tab navigation between modals
        tabShare.addEventListener("click", () => {
            window.modal.show("/com/share", { project });
        });

        // tabEmbed.addEventListener("click", () => {
        //     window.modal.show("/com/embed", { project });
        // });

        tabPublish.addEventListener("click", () => {
            /* already here, do nothing */
        });
    }

    // -------------------------------------------------------
    // FORM SAVE HANDLER (PUBLISH)
    // -------------------------------------------------------

    $("#publish-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const project = component.context.project;
        const tokenParam = { token: (await getAuth()).getSessionToken() };
        await fetch(urlFor(`/projects/${encodeURIComponent(project.name)}`, tokenParam, window.session.claims.username), {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ publish_source: $("#publish-source").value })
        });
        window.modal.finish();
    });
</script>

<div class="dialog-tabs">
    <button id="tab-share"   class="dialog-tab">Share</button>
    <!-- <button id="tab-embed"   class="dialog-tab">Embed</button> -->
    <button id="tab-publish" class="dialog-tab dialog-tab-active">Publish</button>
</div>

<form id="publish-form" method="dialog" class="dialog">
<div class="dialog-header">
    <h2>Public</h2>
    <button class="dialog-close" onclick="window.modal.close()" type="button">&times;</button>
</div>
<div class="dialog-body">
    <label for="publish-source">Source</label>
    <input id="publish-source" name="publish-source" type="text" value="public" pattern="[A-Za-z][A-Za-z0-9_\-]{1,23}"
      oninput="this.value = this.value.replace(/[^A-Za-z0-9_\-]/g, '')"
      title="Names can only contain letters, numbers, dashes, and underscores" required />

    <label for="publish-url">Publish URL</label>
    <input id="publish-url" type="text" value="https://progrium.aptn.pub/foobar" spellcheck="false" />
</div>

<div class="dialog-footer">
    <button class="btn" type="button" onclick="window.modal.finish()">Cancel</button>
    <button class="btn primary" id="project-submit" type="submit">Publish</button>
</div>
</form>


</html>