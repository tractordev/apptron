<html>
<style>
    @import url("/styles.css");
    :host {
        display: block;
    }
</style>

<div class="dialog-header">
    <h2>Share</h2>
    <button class="dialog-close" type="button" onclick="window.modal.finish()" aria-label="Close">&times;</button>
</div>
<div class="dialog-body">
    <div id="share-block">
        <label for="share-url">Share url</label>
        <input id="share-url" type="text" spellcheck="false" />
        <button id="copy" type="button" class="btn secondary">Copy</button>
    </div>

    <div class="dialog-footer">
        <button type="button" class="btn secondary" onclick="window.modal.finish()">Cancel</button>
    </div>
</div>

<script type="module">
    async function copyText(text) {
        try {
            await navigator.clipboard.writeText(text);     // modern path
            return true;
        } catch {
            try {                                          // fallback
                const ta = document.createElement("textarea");
                ta.value = text;
                ta.setAttribute("readonly", "");
                ta.style.position = "absolute";
                ta.style.left = "-9999px";
                document.body.appendChild(ta);
                ta.select();
                const ok = document.execCommand("copy");
                document.body.removeChild(ta);
                return ok;
            } catch { return false; }
        }
    }

    // Defer until the componentâ€™s DOM is stamped
    queueMicrotask(() => {
        const input   = $("#share-url");
        const shareBlock   = $('#share-block');
        const copyBtn = $('#copy');
        const { url, project } = component?.context || {};
        
        // set the share url
        const u = new URL(window.location.href);
        u.searchParams.delete("env");
        input.value = u.toString();

        // Hide controls if project is not public
        if (project?.visibility !== "public") {
            shareBlock?.toggleAttribute("hidden", true);
        }

        // Wire up Copy button if visible
        copyBtn?.addEventListener("click", async () => {
            const ok = await copyText(input?.value || "");
            copyBtn.textContent = ok ? "Copied!" : "Copy failed";
            setTimeout(() => (copyBtn.textContent = "Copy"), 1200);
        });

        // Optional: focus/select when visible
        if (input && !input.hidden) queueMicrotask(() => input.select());
    });
</script>
</html>