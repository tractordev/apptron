<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Apptron</title>

  <!-- Mobile tweaks -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Code">
  <link rel="apple-touch-icon" href="/vscode/code-192.png" />

  <link rel="stylesheet" href="/styles.css" />

  <!-- Disable pinch zooming -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">

  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

  <script src="/topbar/topbar.js" type="module"></script>

  <style>
    body {
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }
    iframe {
        border: 0;
        flex: 1;
        pointer-events: auto !important;
        user-select: none;
    }
  </style>

</head>
<body>
    <script type="module">
        import { setupWanix, bootBundle, getAuth, envUUID, getMeta } from "/apptron.js";
        const auth = await getAuth();
        const origin = window.location.origin;
        window.apptron = {
            user: auth.getUser(), // this promise will be resolved later
            origin: origin,
            env: {
                "uuid": envUUID(),
                "name": getMeta("env-name"),
            }
        }
        
        const w = setupWanix();
        
        // need to register this as early as possible
        window.addEventListener("message", async (event) => {
            if (event.data.port) {
                console.log("waiting for wanix...");
                await w.ready();
                
                
                // xterm.js mode 
                // const xid = (await w.readText("web/dom/new/xterm")).trim();
                // await w.writeFile("task/1/ctl", `bind #console/data web/dom/${xid}/data`);
                // await w.writeFile("web/dom/body/ctl", `append-child ${xid}`);

                console.log("creating port...");
                const port = w.createPort();
                
                console.log("booting bundle...");
                await bootBundle(w);

                console.log("sending port to vscode", port);
                event.data.port.postMessage({wanix: port}, [port]); 
            }
        });
        
    </script>
    <div style="height: 35px;">
        <apptron-topbar></apptron-topbar>
      </div>
    <iframe src="/_vscode" 
        allow="clipboard-read; clipboard-write; cross-origin-isolated"
        sandbox="allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-presentation allow-popups-to-escape-sandbox"></iframe>
    

</body>
</html>
