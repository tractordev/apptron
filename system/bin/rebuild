#!/bin/busybox sh

set -euo pipefail

# delete old env root
rm -rf /web/idbfs/apptron/env/$ENV_UUID/root

env_overlay=/web/idbfs/apptron/env/$ENV_UUID/overlay
buildroot=/apptron/.buildroot

echo "!! Building environment..."

mount -o bind /dev $buildroot/dev
mount -t proc proc $buildroot/proc
mount -t sysfs sys $buildroot/sys

cp /project/.apptron/envbuild $buildroot/.envbuild
chroot $buildroot /bin/sh -c ". .envbuild"

umount $buildroot/dev
umount $buildroot/proc
umount $buildroot/sys

rm $buildroot/.envbuild
rm -rf $env_overlay
echo cp '#envbuild' "${env_overlay:1}" >> /ctl
echo "reload" >> /ctl
