#!/bin/busybox sh

mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t binfmt_misc none /proc/sys/fs/binfmt_misc

# register wasm binary format
echo ':wasm:M::\x00\x61\x73\x6d::/bin/wexec:' > /proc/sys/fs/binfmt_misc/register

# configure networking
ifconfig eth0 up
ifconfig lo up
udhcpc -i eth0 -s /bin/post-dhcp

source /etc/profile # loads apptron.sh for ENV_UUID, SESSION_IP

if [ -f /project/.apptron/envbuild ]; then
    env_overlay=/web/idbfs/apptron/env/$ENV_UUID/overlay
    # if overlay doesn't exist or is older than envbuild, rebuild
    if [ ! -e $env_overlay ] || [ /project/.apptron/envbuild -nt $env_overlay ]; then
        echo
        exec /bin/rebuild
    fi
fi

if [ ! -f /web/idbfs/apptron/.welcomed ]; then
    /bin/open /apptron/WELCOME.md
    touch /web/idbfs/apptron/.welcomed
fi

/bin/aptn ports &
# /bin/aptn fuse &

exec /bin/start
